{% extends "base.html" %}
{% block content %}

<style type="text/css">
    label {
        display: inline-block;
        width:150px;
        text-align: right;
    }

    ul.errorList {
        color: #981919;
        font-weight: bold;
        list-style-type: none;
    }

    #id_description {
        height: 100px;
    }

    #canvasContainer {
        height: 600px;
        width: 350px;
        overflow: auto;
        float: right;
    }

    #formContainer {
        float: left;
    }

</style>

<script src="https://code.jquery.com/jquery.js"></script>
<script type="text/javascript">
var layerCount = 0;
$(document).ready( function () {
    $("[name=creator]").val("{{ user.username }}");
    layerCount = parseInt($("[name=layer_count]").val());

    $("#add-layer").click(function() {
        input = $('<input type="text">');
        input.attr('name', 'layer_' + layerCount);
        input.attr('id', 'id_layer_' + layerCount);

        label = $('<label></label> ');
        label.attr('for', 'id_layer_' + layerCount);
        label.text("Layer " + layerCount + ":");

        div = $('<div class="fieldWrapper"></div>');

        div.append(label);
        div.append(' ');
        div.append(input);
        div.hide().appendTo('#layers').fadeIn(400);

        layerCount ++;
        $("[name=layer_count]").val(layerCount);
    });

    $("#delete-layer").click(function() {
        if (layerCount > 0) {
            layerCount --;
            $("[name=layer_count]").val(layerCount);

            layerWrapper = $("#id_layer_" + layerCount).parent(".fieldWrapper");
            layerWrapper.fadeOut(300, function() { $(this).remove(); });
        };
    });

    $("#preview").click( function() {
        preview();
        setInterval ("preview()", 50);funcName, delay
    });
});

function preview() {
    $("#previewCanvas").remove();
    var topology = getTopology();
    drawTopology(topology);
}

function getTopology() {
    var topology = new Array();
    topology[0] = $("#id_visible").val();
    for (var i = 0; i < layerCount; i++) {
        topology[1 + i] = $("#id_layer_" + i).val();
    };
    topology[layerCount + 1] = $("#id_labels").val();
    return topology;
}

function drawTopology(topology) {
    var height = 60;
    var gap = 40;
    var textOffset = height + 15;
    var perHeight = height + gap;
    var canvasHeight = perHeight * (layerCount + 2);
    var canvasWidth = 300;
    var canvas = $('<canvas />').attr({
        id: "previewCanvas",
        width: canvasWidth,
        height: canvasHeight
    });
    canvas.appendTo('#canvasContainer');

    var ctx = $("#previewCanvas")[0].getContext("2d");
    ctx.clearRect(0,0,canvasWidth,canvasHeight);
    ctx.fillStyle = "#000000";
    ctx.font = '8pt Calibri';
    ctx.textAlign = 'left';
    var max = Math.max.apply(Math, topology);
    var ratio = canvasWidth/max;
    var widths = $.map(topology, function(n) {
        return Math.round(ratio*n);
    });

    var currentHeight = canvasHeight - perHeight;
    for (var i = 0; i < layerCount + 2; i++) {
        fillRandomPixels(ctx, (canvasWidth/2) - widths[i]/2, currentHeight, widths[i], height);
        if (i == 0) {
            ctx.fillText("Input Data: " + topology[0] + " nodes", 0, currentHeight + textOffset);
        } else if (i == layerCount + 1) {
            ctx.fillText("Classifier: " + topology[layerCount + 1] + " nodes", 0, currentHeight + textOffset);
        } else {
            ctx.fillText(("Layer " + (i-1)) + ": " + topology[i] + " nodes", 0, currentHeight + textOffset);
        };
        currentHeight = currentHeight - perHeight;
    };
}

function fillRandomPixels(ctx,xcoord,ycoord,width,height, pixels) {
    for (var x = 0; x < width; x++) {
        for (var y = 0; y < height; y++) {
            var prob = Math.floor(Math.random()*2);
            if (prob == 1) {
                ctx.fillRect(xcoord + x, ycoord + y, 1, 1);
            };
        };
    };
}
</script>

<div id="formContainer">
<form action="{% url 'create' %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}

    {% for hidden in form.hidden_fields %}
        {{ hidden }}
    {% endfor %}

    <div class="fieldWrapper">
        {{ form.name.errors }}
        <label for="id_name">Name:</label>
        {{ form.name }}
    </div>
    <div class="fieldWrapper">
        {{ form.description.errors }}
        <label for="id_description">Description:</label>
        {{ form.description }}
    </div>
    <div class="fieldWrapper">
        {{ form.learning_rate.errors }}
        <label for="id_learning_rate">Learning Rate:</label>
        {{ form.learning_rate }}
    </div>
    <div class="fieldWrapper">
        {{ form.visible.errors }}
        <label for="id_visible">Input Nodes:</label>
        {{ form.visible }}
    </div>
    <div id="layers">
        {% for field in form.visible_fields %}
            {% if "Layer" in field.label %}
                <div class="fieldWrapper">
                    {{ field.errors }}
                    {{ field.label_tag }} {{ field }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="fieldWrapper">
        {{ form.labels.errors }}
        <label for="id_labels">No. Labels:</label>
        {{ form.labels }}
    </div>
    <!--
    <div class="fieldWrapper">
        {{ form.training_data.errors }}
        <label for="id_training_data">Training Data:</label>
        {{ form.training_data }}
    </div>
    -->
    <p><input type="submit" value="Create DBN" /></p>
</form>

<button id="add-layer">Add layer</button>
<button id="delete-layer">Delete layer</button>
<button id="preview">Preview</button>
</div>

<div id="canvasContainer">
</div>

{% endblock %}

{% block create_link_class %} class="active" {% endblock %}
